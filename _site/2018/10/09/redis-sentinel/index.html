<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords"  content=" ">
    <meta name="theme-color" content="#000000">
    
    <title>redis的哨兵 - zwt's Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4001/2018/10/09/redis-sentinel/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">zwtisme</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/articles/">Articles</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#redis" title="redis">redis</a>
                        
                    </div>
                    <h1>redis的哨兵</h1>
                    
                    
                    <h2 class="subheading">Redis Sentinel</h2>
                    
                    <span class="meta">Posted by zwtisme on October 9, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                 col-lg-8 col-lg-offset-2
                 col-md-10 col-md-offset-1
                 post-container">

                <!-- Multi-Lingual -->
                

                <blockquote>
  <p>介绍使用redis哨兵进行自动故障转移</p>
</blockquote>

<h2 id="前言">前言</h2>

<p>
为了增强缓存服务器的高可用可使用redis的哨兵监控，来实现主节点发生故障时的自动转移。
</p>

<h2 id="准备工作">准备工作</h2>

<p>
由于机器的限制，此文章中的redis实例都是在一台机器上启动的，通过不同的port来模拟不同的redis实例。
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ps -ef|grep redis
root      4104     1  0 13:14 ?        00:00:00 ./redis-server *:6380    
root      4113     1  0 13:18 ?        00:00:00 ./redis-server *:6381    
root      4121     1  0 13:19 ?        00:00:00 ./redis-server *:6382    
root      4129     1  0 13:19 ?        00:00:00 ./redis-server *:6383 
</code></pre></div></div>

<h2 id="配置文件">配置文件</h2>

<p>
哨兵节点对应的配置文件为<code>sentinel.conf</code>，有如下一些配置项
</p>

<table border="1" cellpadding="0" cellspacing="0" style="width:700px">
	<tbody>
		<tr>
			<td>名称</td>
			<td>说明</td>
			<td>可选值</td>
		</tr>
		<tr>
			<td>bind</td>
			<td>允许访问节点的ip<br />
			protected-mode=yes时设置</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>protected-mode</td>
			<td>保护模式<br />
			设置为no，确保网络在内网环境</td>
			<td>yes|no</td>
		</tr>
		<tr>
			<td>port</td>
			<td>端口</td>
			<td>整数</td>
		</tr>
		<tr>
			<td>daemonize</td>
			<td>守护进程</td>
			<td>yes|no</td>
		</tr>
		<tr>
			<td>pidfile</td>
			<td>进程文件</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>logfile</td>
			<td>日志文件</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>sentinel announce-ip</td>
			<td colspan="1" rowspan="2">对外宣称ip或port</td>
			<td colspan="1" rowspan="2">自定义</td>
		</tr>
		<tr>
			<td>sentinel announce-port</td>
		</tr>
		<tr>
			<td>dir</td>
			<td>工作目录</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>sentinel monitor<br />
			&lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</td>
			<td>监控的主节点<br />
			quorum：<br />
			1.至少有quorum个哨兵节点认为不可达，才会故障转移<br />
			2.至少有max(quorum,num(哨兵个数)/2+1)个哨兵节点参与选举才能进行故障转移</td>
			<td>整数</td>
		</tr>
		<tr>
			<td>sentinel auth-pass<br />
			&lt;master-name&gt; &lt;password&gt;</td>
			<td>主节点密码</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>sentinel down-after-milliseconds<br />
			&lt;master-name&gt; &lt;milliseconds&gt;</td>
			<td>节点不可达的判断时间</td>
			<td>整数</td>
		</tr>
		<tr>
			<td>sentinel parallel-syncs<br />
			&lt;master-name&gt; &lt;numreplicas&gt;</td>
			<td>新主节点出来后，同时有几个从节点进行复制操作</td>
			<td>整数</td>
		</tr>
		<tr>
			<td>sentinel failover-timeout<br />
			&lt;master-name&gt; &lt;milliseconds&gt;</td>
			<td>故障转移超时时间</td>
			<td>整数</td>
		</tr>
		<tr>
			<td>sentinel notification-script<br />
			&lt;master-name&gt; &lt;script-path&gt;</td>
			<td>配置脚本记录故障转移期间的事件</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>sentinel client-reconfig-script<br />
			&lt;master-name&gt; &lt;script-path&gt;</td>
			<td>配置脚本记录故障转移结束后的处理结果</td>
			<td>自定义</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td>&nbsp;</td>
			<td>&nbsp;</td>
		</tr>
	</tbody>
</table>

<p>
如果想动态的调整配置，可通过如下命令
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sentinel set &lt;param&gt; &lt;value&gt;
</code></pre></div></div>

<table border="1" cellpadding="0" cellspacing="0" style="width:700px">
	<tbody>
		<tr>
			<td>参数</td>
			<td>使用方法</td>
		</tr>
		<tr>
			<td>quorum</td>
			<td>sentinel set master1 quorum 2</td>
		</tr>
		<tr>
			<td>auth-pass</td>
			<td>sentinel set master1 auth-pass password</td>
		</tr>
		<tr>
			<td>down-after-milliseconds</td>
			<td>sentinel set master1 down-after-milliseconds 1000</td>
		</tr>
		<tr>
			<td>parallel-syncs</td>
			<td>sentinel set master1 parallel-syncs 1</td>
		</tr>
		<tr>
			<td>failover-timeout</td>
			<td>sentinel set master1 failover-timeout&nbsp;5000</td>
		</tr>
		<tr>
			<td>notification-script</td>
			<td>sentinel set master1 notification-script&nbsp;/x.sh</td>
		</tr>
		<tr>
			<td>client-reconfig-script</td>
			<td>sentinel set master1 client-reconfig-script&nbsp;/y.sh</td>
		</tr>
	</tbody>
</table>

<p>
在调整配置时需要注意以下几点：
</p>

<ul>
  <li>只对当前调整的节点有效</li>
  <li>配置调整成功会直接刷新配置文件</li>
  <li>所有的哨兵节点配置最好是一致的</li>
</ul>

<h2 id="部署">部署</h2>

<h4 id="拓扑结构">拓扑结构</h4>

<p>
这里以1个主节点，3个从节点，4个哨兵节点来组成一个Redis Sentinel。
</p>

<p><img src="http://localhost:4001/img/2018-10-09-redis-sentinel/20181009135214.png?raw=true" alt="image" /></p>

<h4 id="数据节点">数据节点</h4>

<h5 id="主节点">主节点</h5>

<p>
主要配置如下：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#6380
#端口
port 6380
#守护进程
daemonize yes
#rdb文件
dbfilename "dump.rdb"
#工作目录
dir "./"
#日志文件
logfile "redis-server.log"
</code></pre></div></div>

<p>
主节点启动
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6380]# ./redis-server redis.conf 

#检查服务状态
[root@vagrant redis-6380]# ps -ef|grep redis
root      4156     1  0 14:07 ?        00:00:00 ./redis-server *:6380    
</code></pre></div></div>

<h5 id="从节点">从节点</h5>

<p>
主要配置如下，增加了slaveof配置：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#6381,6382,6383
#端口
port 6381
#守护进程
daemonize yes
#rdb文件
dbfilename "dump.rdb"
#工作目录
dir "./"
#日志文件
logfile "redis-server.log"
#设置复制主节点
slaveof 127.0.0.1 6380
</code></pre></div></div>

<p>
从节点启动
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6381]# ./redis-server redis.conf 
[root@vagrant redis-6382]# ./redis-server redis.conf 
[root@vagrant redis-6383]# ./redis-server redis.conf 

#检查服务状态
[root@vagrant redis-6383]# ps -ef|grep redis
root      4156     1  0 14:07 ?        00:00:00 ./redis-server *:6380    
root      4164     1  0 14:13 ?        00:00:00 ./redis-server *:6381    
root      4175     1  0 14:14 ?        00:00:00 ./redis-server *:6382    
root      4183     1  0 14:15 ?        00:00:00 ./redis-server *:6383    
</code></pre></div></div>

<h5 id="主从关系">主从关系</h5>

<p>
主节点视角：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 6380 info replication
# Replication
role:master
connected_slaves:3
slave0:ip=127.0.0.1,port=6381,state=online,offset=210,lag=1
slave1:ip=127.0.0.1,port=6382,state=online,offset=210,lag=1
slave2:ip=127.0.0.1,port=6383,state=online,offset=210,lag=1
</code></pre></div></div>

<p>
从节点视角：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 6381 info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6380
master_link_status:up
</code></pre></div></div>

<h4 id="哨兵节点">哨兵节点</h4>

<h5 id="哨兵配置">哨兵配置</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#26380,26381,26382,26383
#端口
port 26380
#守护进程
daemonize yes
#工作目录
dir "./"
#日志文件
logfile "redis-sentinel.log"
#监控的主节点
sentinel monitor master1 127.0.0.1 6380 2
#节点不可达判断时间
sentinel down-after-milliseconds master1 1000
#同时向新主节点发起复制操作的节点个数
sentinel parallel-syncs master1 1
#故障转移超时时间
sentinel failover-timeout master1 5000
</code></pre></div></div>

<p>
<font color="red">
Tips：不要手动设置sentinel myid值，此值会自动生成
</font>
</p>

<h5 id="哨兵启动">哨兵启动</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6380]# ./redis-sentinel sentinel.conf 
[root@vagrant redis-6381]# ./redis-sentinel sentinel.conf 
[root@vagrant redis-6382]# ./redis-sentinel sentinel.conf 
[root@vagrant redis-6383]# ./redis-sentinel sentinel.conf 
</code></pre></div></div>

<h5 id="配置变化">配置变化</h5>

<p>
当哨兵节点都启动完成后，配置文件会被自动修改掉。
</p>

<p>
减少的配置：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sentinel parallel-syncs master1 1
</code></pre></div></div>

<p>
增加的配置：
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#最后的数字表示是第几次进行故障转移
sentinel config-epoch master1 0
sentinel leader-epoch master1 0
#自动发现3个从节点
sentinel known-slave master1 127.0.0.1 6382
sentinel known-slave master1 127.0.0.1 6383
sentinel known-slave master1 127.0.0.1 6381
#自动发现除自身的3个哨兵节点
sentinel known-sentinel master1 127.0.0.1 26381 29e2457f28a8fecd77f253b542f10523878c4e59
sentinel known-sentinel master1 127.0.0.1 26380 699c1928d7ebe3b9f3a8395e824313e1e8f66a7e
sentinel known-sentinel master1 127.0.0.1 26382 8b1933d36031e2b9ee581f8269ac4bd427bb6063
sentinel current-epoch 0
</code></pre></div></div>

<h5 id="哨兵确认">哨兵确认</h5>

<p>
检查哨兵的状态是否与配置的一致
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 info sentinel
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=master1,status=ok,address=127.0.0.1:6380,slaves=3,sentinels=4
</code></pre></div></div>
<h2 id="api">API</h2>

<p>
哨兵节点作为一个特殊的redis节点，有如下一些专属的api
</p>

<h5 id="sentinel-masters">sentinel masters</h5>

<p>
查看所有被监控的主节点信息
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel masters
1)  1) "name"
    2) "master1"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "6382"
    ...
</code></pre></div></div>

<h5 id="sentinel-master-">sentinel master <master name=""></master></h5>

<p>
查看某个主节点的信息
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel master master1
 1) "name"
 2) "master1"
 3) "ip"
 4) "127.0.0.1"
 5) "port"
 6) "6382"
 ...
</code></pre></div></div>

<h5 id="sentinel-slaves-">sentinel slaves <master name=""></master></h5>

<p>
查看某个主节点下从节点的信息
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel slaves master1
1)  1) "name"
    2) "127.0.0.1:6380"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "6380"
    ...
2)  1) "name"
    2) "127.0.0.1:6381"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "6381"
    ...
3)  1) "name"
    2) "127.0.0.1:6383"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "6383"
    ...
</code></pre></div></div>

<h5 id="sentinel-sentinels-">sentinel sentinels <master name=""></master></h5>

<p>
查看某个主节点下哨兵的信息，不包括当前使用哨兵
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel sentinels master1
1)  1) "name"
    2) "f1b42cce7da99809b392a51b366cde7b3b6f6048"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "26383"
    ...
2)  1) "name"
    2) "8b1933d36031e2b9ee581f8269ac4bd427bb6063"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "26382"
    ...
3)  1) "name"
    2) "29e2457f28a8fecd77f253b542f10523878c4e59"
    3) "ip"
    4) "127.0.0.1"
    5) "port"
    6) "26381"
</code></pre></div></div>

<h5 id="sentinel-get-master-addr-by-name-">sentinel get-master-addr-by-name <master name=""></master></h5>

<p>
查看某个主节点的ip与port信息
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel get-master-addr-by-name master1
1) "127.0.0.1"
2) "6382"
</code></pre></div></div>

<h5 id="sentinel-reset-">sentinel reset <pattern></pattern></h5>

<p>
重置匹配主节点的配置，清除主节点的相关状态（例如故障转移），重新发现从节点和哨兵节点
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel reset master1
(integer) 1
</code></pre></div></div>

<h5 id="sentinel-failover-">sentinel failover <master name=""></master></h5>

<p>
对主节点进行强制故障转移
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel failover master1
OK
</code></pre></div></div>

<h5 id="sentinel-ckquorum-">sentinel ckquorum <master name=""></master></h5>

<p>
检查当前的可达哨兵节点数是否达到<code>quorum</code>个数，如果达不到则无法进行故障转移
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel ckquorum master1
OK 4 usable Sentinels. Quorum and failover authorization can be reached
</code></pre></div></div>

<h5 id="sentinel-flushconfig">sentinel flushconfig</h5>

<p>
将哨兵节点的配置更新到磁盘
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel flushconfig
OK
</code></pre></div></div>

<h5 id="sentinel-remove-">sentinel remove <master name=""></master></h5>

<p>
取消当前哨兵节点对某个主节点的监控
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel remove master1
OK
</code></pre></div></div>

<h5 id="sentinel-monitor----">sentinel monitor <master name=""> <ip> <port> <quorum></quorum></port></ip></master></h5>

<p>
对当前哨兵节点添加对某个主节点的监控
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -p 26380 sentinel monitor master1 127.0.0.1 6381 2
OK
</code></pre></div></div>

<h5 id="sentinel-set---">sentinel set <master name=""> <param /> <value></value></master></h5>

<p>
动态修改哨兵的配置，只对当前哨兵生效。修改成功后会立即更新配置文件，不同于redis.conf需要执行config rewrite。
</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6380]# ./redis-cli -p 26380 sentinel set master1 quorum 3
OK
</code></pre></div></div>

<h5 id="sentinel-is-master-down-by-addr">sentinel is-master-down-by-addr</h5>

<p>
Sentinel节点之间用来交换对主节点是否下线的判断，根据参数的不同，还可以作为Sentinel领导者选举的通信方式
</p>

<h2 id="原理">原理</h2>

<h4 id="定时监控任务">定时监控任务</h4>

<h5 id="1间隔10s">1.间隔10s</h5>

<p>
每个sentinel通过主从节点获取info信息，更新拓扑结构。主要作用如下：
</p>

<ul>
  <li>通过主节点获取从节点信息，sentinel节点不需要显式配置从节点的原因</li>
  <li>自动感知新加入的从节点</li>
  <li>节点不可达或故障转移后，更新最新的拓扑信息</li>
</ul>

<p><img src="http://localhost:4001/img/2018-10-09-redis-sentinel/20181011165230.png?raw=true" alt="image" /></p>

<h5 id="2间隔2s">2.间隔2s</h5>

<p>
每个sentinel节点向所有redis数据节点的<code>__sentinel__:hello</code>频道发送该sentinel节点的信息及主节点的信息，同时也订阅所有数据节点上的<code>__sentinel__:hello</code>频道来获取其他sentinel节点的信息与主节点信息。主要作用如下：
</p>

<ul>
  <li>发现新的sentinel节点，与它们建立连接</li>
  <li>sentinel节点之间交换主节点的状态，用于客观下线以及领导者选举的判断</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#接收到的消息
[root@vagrant redis-6383]# ./redis-cli -p 6381 subscribe __sentinel__:hello
Reading messages... (press Ctrl-C to quit)
1) "subscribe"
2) "__sentinel__:hello"
3) (integer) 1
1) "message"
2) "__sentinel__:hello"
3) "127.0.0.1,26381,29e2457f28a8fecd77f253b542f10523878c4e59,7,master1,127.0.0.1,6381,7"
1) "message"
2) "__sentinel__:hello"
3) "127.0.0.1,26382,8b1933d36031e2b9ee581f8269ac4bd427bb6063,7,master1,127.0.0.1,6381,7"
1) "message"
2) "__sentinel__:hello"
3) "127.0.0.1,26383,f1b42cce7da99809b392a51b366cde7b3b6f6048,7,master1,127.0.0.1,6381,7"
1) "message"
2) "__sentinel__:hello"
3) "1.1.1.1,26380,699c1928d7ebe3b9f3a8395e824313e1e8f66a7e,7,master1,127.0.0.1,6381,7"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Sentinel节点IP&gt; &lt;Sentinel节点端口&gt; &lt;Sentinel节点runId&gt; &lt;Sentinel节点配置版本&gt;&lt;主节点名字&gt; &lt;主节点Ip&gt; &lt;主节点端口&gt; &lt;主节点配置版本&gt;
</code></pre></div></div>

<p><img src="http://localhost:4001/img/2018-10-09-redis-sentinel/20181011170255.png?raw=true" alt="image" /></p>

<h5 id="3间隔1s">3.间隔1s</h5>

<p>
每个sentinel节点会向主节点、从节点、其余sentinel节点发送一条ping命令做一次心跳检测，来确认这些节点当前是否可达。
</p>

<p><img src="http://localhost:4001/img/2018-10-09-redis-sentinel/20181011172218.png?raw=true" alt="image" /></p>

<h4 id="主观下线与客观下线">主观下线与客观下线</h4>

<h5 id="主观下线">主观下线</h5>

<p>
当sentinel每隔1秒对主节点、从节点、其他sentinel节点发送ping命令做心跳检测时，如果这些节点超过<code>down-after-milliseconds</code>没有进行有效回复，sentinel节点就认为此节点主观下线。
</p>

<h5 id="客观下线">客观下线</h5>

<p>
当主观下线的节点为主节点时，sentinel会向其他sentinel节点发送<code>sentinel ismaster-down-by-addr</code>命令来获取其他sentinel节点对主节点的判断，如果超过<code>quorum</code>个sentinel节点认为主节点为主观下线，则sentinel会认为主节点为客观下线。
</p>

<p>
命令说明：<code>sentinel is-master-down-by-addr {ip} {port} {current_epoch} {runid}</code>
</p>

<ul>
  <li>ip：主节点ip</li>
  <li>port：主节点端口</li>
  <li>current_epoch：当前配置纪元</li>
  <li>runid：”*“交换对主节点下线的判定，否则当runid等于当前Sentinel节点的runid时，作用是当前Sentinel节点希望目标Sentinel节点同意自己成为领导者的请求</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@vagrant redis-6383]# ./redis-cli -h 127.0.0.1 -p 26380 sentinel is-master-down-by-addr 127.0.0.1 6381 7 '*'
1) (integer) 0
2) "*"
3) (integer) 0
</code></pre></div></div>

<p>
返回结果说明：
</p>

<ul>
  <li>down_state：目标Sentinel节点对于主节点的下线判断，1是下线，0是在线</li>
  <li>leader_runid：当leader_runid等于“*”时，代表返回结果是用来做主节点是否不可达判断的，当leader_runid等于具体的runid，代表目标节点同意runid成为领导者</li>
  <li>领导者纪元</li>
</ul>

<h4 id="sentinel-leader选举">sentinel leader选举</h4>

<p>
实际完成故障转移只需要一个sentinel节点，redis使用了<a target="_blank" href="https://raft.github.io/">raft</a>算法来实现leader的选举，基本上最先完成客观下线的节点就是leader，大致过程如下：
</p>

<ul>
  <li>每个在线的Sentinel节点都有资格成为领导者，当它确认主节点主观下线时候，会向其他Sentinel节点发送sentinel is-master-down-by-addr命令，要求将自己设置为领导者</li>
  <li>收到命令的Sentinel节点，如果没有同意过其他Sentinel节点的sentinelis-master-down-by-addr命令，将同意该请求，否则拒绝</li>
  <li>如果该Sentinel节点发现自己的票数已经大于等于max（quorum，num（sentinels）/2+1），那么它将成为领导者</li>
  <li>如果此过程没有选举出领导者，将进入下一次选举</li>
</ul>

<h4 id="故障转移">故障转移</h4>

<p>
sentinel leader执行故障转移的大致流程如下：
</p>

<p>
1.在从节点中选出一个节点作为新的主节点
</p>

<ul>
  <li>过滤：“不健康”（主观下线、断线）、5秒内没有回复过Sentinel节点ping响应、与主节点失联超过down-after-milliseconds*10秒</li>
  <li>选择slave-priority（从节点优先级）最高的从节点列表，如果存在则返回，不存在则继续</li>
  <li>选择复制偏移量最大的从节点（复制的最完整），如果存在则返回，不存在则继续</li>
  <li>选择runid最小的从节点</li>
</ul>

<p><img src="http://localhost:4001/img/2018-10-09-redis-sentinel/20181012135652.png?raw=true" alt="image" /></p>

<p>
2.sentinel leader对选出来的节点执行<code>slaveof no one</code>让其变为主节点
</p>

<p>
3.sentinel leader向剩余的从节点发送命令，让它们成为新主节点的从节点，复制规则和parallel-syncs参数有关
</p>

<p>
4.sentinel节点集合会将原来的主节点更新为从节点，并保持着对其关注，当其恢复后命令它去复制新的主节点
</p>

<h2 id="参考资料">参考资料</h2>

<p><a href="https://github.com/antirez/redis/blob/unstable/sentinel.conf">sentinel.conf</a></p>

<p><a href="https://github.com/antirez/redis-doc/blob/master/topics/sentinel.md">sentinel topic</a></p>

<p><a href="http://item.jd.com/12121730.html?spm=1.1.1">redis开发与运维</a></p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/10/02/redis-master-slave/" data-toggle="tooltip" data-placement="top" title="redis的主从">
                            Previous<br>
                            <span>redis的主从</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/10/12/redis-cluster/" data-toggle="tooltip" data-placement="top" title="redis的集群">
                            Next<br>
                            <span>redis的集群</span>
                        </a>
                    </li>
                    
                </ul>


                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

            <!-- Side Catalog Container -->
            
            <div class="
                 col-lg-2 col-lg-offset-0
                 visible-lg-block
                 sidebar-container
                 catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            <!-- Sidebar Container -->
            <div class="
                 col-lg-8 col-lg-offset-2
                 col-md-10 col-md-offset-1
                 sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        

                        
                        
                            
                            
                                
                                <a href="/tags/#php" title="php" rel="21">
                                    php
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                            
                                
                                <a href="/tags/#rabbitmq" title="rabbitmq" rel="11">
                                    rabbitmq
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                                <a href="/tags/#redis" title="redis" rel="8">
                                    redis
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                            
                                
                            
                                
                                <a href="/tags/#laravel" title="laravel" rel="7">
                                    laravel
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                                <a href="/tags/#mysql" title="mysql" rel="5">
                                    mysql
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                                <a href="/tags/#linux" title="linux" rel="2">
                                    linux
                                </a>
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                        
                            
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                            
                                
                                <a href="/tags/#swoole" title="swoole" rel="1">
                                    swoole
                                </a>
                                
                            
                                
                            
                                
                                <a href="/tags/#架构" title="架构" rel="1">
                                    架构
                                </a>
                                
                            
                                
                                <a href="/tags/#git" title="git" rel="1">
                                    git
                                </a>
                                
                            
                                
                                <a href="/tags/#tcp/ip" title="tcp/ip" rel="1">
                                    tcp/ip
                                </a>
                                
                            
                                
                                <a href="/tags/#http" title="http" rel="1">
                                    http
                                </a>
                                
                            
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>LINKS</h5>
                <ul class="list-inline">
                    
                    <li><a href="http://www.ruanyifeng.com/home.html">阮一峰的个人网站</a></li>
                    
                    <li><a href="https://www.zhangxinxu.com/">张鑫旭的个人主页</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "zwtisme";
    var disqus_identifier = "/2018/10/09/redis-sentinel";
    var disqus_url = "http://localhost:4001/2018/10/09/redis-sentinel/";
    /*
     (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
     */
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
                o = d.createElement(t),
                s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function (e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js", function () {
        anchors.options = {
            visible: 'always',
            placement: 'right',
            icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; zwtisme 2022
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'https://zwtisme.github.io/';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {

        // interop with multilangual 
        if (false) {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
